---
title: "Fish_decadal_prediction_Figures"
output:
  html_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include="FALSE"}
#'========================================================================
# Fish_decadal_prediction_Figures
#'========================================================================
#
# by Mark R Payne
# DTU-Aqua, Kgs. Lyngby, Denmark
# http://www.staff.dtu.dk/mpay
#
# Created Wed Jul  3 11:16:32 2019
#
# <Description>
#
# This work is subject to a Creative Commons "Attribution" "ShareALike" License.
# You are largely free to do what you like with it, so long as you "attribute"
# me for my contribution. See the fine print at the end for exact details.
#
# To do:
#
# Notes:
#
#'========================================================================

#Notes:
#Make sure when knitting that you have the Knit directory set to "project directory"

#Clean plate
rm(list=ls())

#Configure Knitr
knitr::opts_chunk$set(
  echo=FALSE,
	error = FALSE,
	message = FALSE,
	warning = FALSE,
	include = TRUE,
	results = "markup",
	fig.width = 10,         #Old 4:3
	fig.height=14/25*10,
	fig.width = 10,         #New 16:9
	fig.height=15/32*10,
  fig.align="center",
  fig.path=file.path(".","figures","Fish_decadal_prediction_Figures_"))

#Powerpoint needs 14 x 25cm figures

# knitr::opts_knit$set(
#    root.dir="..")

library(PredEng)
library(scales)
library(here)
library(sf)
library(ggnewscale)
library(RSQLite)
library(RColorBrewer)

theme_set(theme_bw())
theme_replace(strip.text = element_text(hjust=0),
              strip.background = element_blank())
          
```

by Mark R Payne  <br>
DTU-Aqua, Kgs. Lyngby, Denmark  <br>
http://www.staff.dtu.dk/mpay  <br>
Wed Jul  3 11:16:32 2019

This notebook prepares figures for use in the manuscript "Skillful decadal-prediction of distributional shifts in North Atlantic pelagic fish".

## Skill Metrics for oceanographic variables

```{r}
#'========================================================================
# Spatial skill metrics for oceanographic variables ####
#'========================================================================
#Setup
this.dir <- "notebooks/manuscript"

cfgs <- list()
cfgs$Bluefin <- 
  tibble(tbl=PE.cfg$db$metrics,
         spName="SouthOfIceland",
         statName="WestExt",
         resultName="longitude",
         calibrationMethod="MeanAdj",
         lbl="a) Bluefin tuna",
         var="SST",
         fig="skill") 

# cfgs$Blue_whiting_decadal <- 
#   tibble(tbl=PE.cfg$db$metrics,
#          spName="NorthernComponent",
#          statName="SDM",
#          resultName="areaLarvae",
#          calibrationMethod="MeanAdj",
#          lbl="b) Blue whiting",
#          var="Sal",
#          fig="skill")
# cfgs$Mackerel_summer <-
#   tibble(tbl=PE.cfg$db$metrics,
#          spName="Greenland",
#          statName="HabitatModel",
#          resultName="carryingCapacity",
#          calibrationMethod="MeanAdj",
#          lbl="c) Mackerel",
#          var="SST",
#          fig="skill") 
# cfgs$NA_SST <-
#   tibble(tbl=PE.cfg$db$metrics.field,
#          spName="globalROI",
#          statName="Anomaly",
#          resultName="field",
#          calibrationMethod="anomaly",
#          var="SST",
#          fig="spMet")
# cfgs$NA_Sal <-
#   tibble(tbl=PE.cfg$db$metrics.field,
#          spName="globalROI",
#          statName="Anomaly",
#          resultName="field",
#          calibrationMethod="anomaly",
#         var="Sal",
#          fig="spMet")

#Import extermaæ pbkects
these.cfg <-
  bind_rows(cfgs,.id="name") %>%
  mutate(pcfg=map(name,~readRDS(here(this.dir,.x,"configuration.rds"))),
         stats.db=map(name,~dbConnect(SQLite(),here(this.dir,.x,sprintf("%s_statistics.sqlite",.x)))), 
         mets.db=map(name,~dbConnect(SQLite(),here(this.dir,.x,sprintf("%s_metrics.sqlite",.x))))) 

#Import data and select skill metrics
metrics.dat <-
  these.cfg %>%
  rowwise() %>%
  group_split() %>%
  map_dfr(function(this) {
    this$mets.dat <- 
      this$mets.db[[1]] %>%
      tbl("metrics") %>%
      filter(spName==!!this$spName,
             statName==!!this$statName,
             resultName==!!this$resultName) %>%
      collect() %>%
      filter(calibrationMethod==this$calibrationMethod | is.na(calibrationMethod)) %>%
      PE.db.unserialize() %>%
      list()
    return(this)
  })

```


## Skill Metrics for each fish stock

```{r, fig.height=10,fig.width=5.6}
#'========================================================================
# Skill metrics by fish stock ####
##TODO:
## * Add statistical significance
## * Correct time axis
#'========================================================================
#Process skill data
skill.cfgs <- 
  metrics.dat %>%
  filter(fig=="skill") 

skill.dat <- 
  skill.cfgs %>%
  select(lbl,mets.dat) %>%
  unnest(mets.dat) %>%
  filter(srcType %in% c("Decadal","Persistence"),
         realization %in% c("ensmean","realmean",NA))  %>%
  mutate(lead.yrs=lead/12,
         highlight=srcName=="ensmean" | srcType=="Persistence",
         dispName=ifelse(srcType=="Persistence","Persistence",srcName),
         dispName=fct_relevel(dispName,"ensmean","Persistence"),
         dispName=fct_recode(dispName,"Ens. mean"="ensmean"))

#Remove stray persistences
decadal.leads <- 
  skill.dat %>%
  filter(srcType=="Decadal") %>%
  distinct(lbl,lead) %>%
  unite(lbl.lead,lbl,lead) %>%
  pull()

cleaned.dat <- 
  skill.dat %>%
  filter(metric=="pearson.correlation") %>%
  unite(lbl.lead,lbl,lead,remove=FALSE) %>%
  filter(lbl.lead %in% decadal.leads) 

#Now split into individuals models
models.dat <- 
  cleaned.dat %>%
  filter(!highlight)  #Use the best estimate 

ensmean.dat <-
  cleaned.dat %>%
  filter(dispName=="Ens. mean")

persis.dat <-
  cleaned.dat %>%
  filter(dispName=="Persistence") 

highlight.dat <-
  cleaned.dat %>%
  filter(highlight) %>%
  mutate(upperCI=map_dbl(draws,quantile,probs=0.95),
         lowerCI=map_dbl(draws,quantile,probs=0.05))

signif.dat <- 
  highlight.dat %>%
  select(lbl,lead.yrs,draws,dispName) %>%
  pivot_wider(names_from="dispName",values_from = "draws") %>%
  mutate(p.value=map2_dbl(`Ens. mean`,Persistence, ~ mean(.x < .y)),
         p.txt=cut(p.value,breaks=c(-1,0.001,0.01,0.05,1),
                   labels=c("p < 0.001","p < 0.01", "p < 0.05", "ns")))

#Plot miscs
colour.pal <- hue_pal()(7)


g <- 
  #Setup baseline
  ggplot()+
  facet_wrap(~lbl,ncol=1)+
  annotate("rect",xmin=0,xmax=10,ymin=1,ymax=1.1,fill="white",colour="black")+
  scale_linetype_manual(values="dotted")+
  coord_cartesian(xlim=c(0,10),ylim=c(0,1.1),expand=FALSE)+
  scale_x_continuous(breaks=0:10)+
  theme(legend.position="bottom")+
  labs(x="Lead time (years)",
       y="Pearson correlation coefficient (r)")+
  #Highlight bands
  geom_ribbon(mapping=aes(x=lead.yrs,
                          ymin=lowerCI,
                          ymax=upperCI,
                          fill=dispName),
              data=highlight.dat,
              alpha=0.25,
              show.legend = FALSE)+
  scale_fill_manual(values=colour.pal[1:2])+
  #Individual model plots
  geom_line(data=models.dat,
            mapping=aes(x=lead.yrs,
                        y=value,
                        colour=dispName),
            size=0.2)+
  scale_colour_manual(values=colour.pal[-c(1:2)],
                      guide=guide_legend(order=2,ncol=1,
                                         title="Individual Models",title.position = "top"))+
  guides(linetype=guide_legend(title.position = "top"))+

  #Highlight plots
  new_scale_colour()+
  geom_line(data=highlight.dat,
            mapping=aes(x=lead.yrs,
                        y=value,
                        colour=dispName),
            size=2)+
  scale_colour_manual(values=colour.pal[1:2],
                      guide=guide_legend(order=1,ncol=1,
                                         title="Key Metrics",
                                         title.position = "top"))+
  geom_point(data=signif.dat,
             mapping=aes(x=lead.yrs,y=1.05,shape=p.txt,size=p.txt))+
  scale_shape_manual(values=c(17,24,3,1),
                     drop=FALSE,
                     guide=guide_legend(order=3,ncol=1,
                                         title="Signif. test",
                                         title.position = "top"))+
  scale_size_manual(values=c(4,4,2,0.1),
                     drop=FALSE,
                     guide=guide_legend(order=3,ncol=1,
                                         title="Signif. test",
                                         title.position = "top"))

print(g)


```


## Ability to forecast given years
```{r}
# Import data ---------------------------------------------------------------------
sel.cfg <- 
  these.cfg %>%
  filter(name==this.stk) 

sel.tbl <-
  sel.cfg %>%
  select(db,spName,statName,resultName,calibrationMethod) %>%
  do.call(what=function(db,spName,statName,resultName,calibrationMethod) {
    tbl(db[[1]],PE.cfg$db$stats) %>%
      filter(spName==!!spName,
             statName==!!statName,
             resultName==!!resultName,
             calibrationMethod==!!calibrationMethod)
  }) 

sel.obs <-
  sel.tbl %>%
  filter(srcType=="Observations") %>%
  collect() %>%
  filter(year(date)%in% yr.rng,
         month(date) ==sel.cfg$pcfg[[1]]@MOI) %>%
  mutate(value=value)

sel.model <-
  sel.tbl %>%
  filter(srcType=="Decadal",
         srcName=="CESM.DPLE") %>%
  collect() %>%
  filter(year(date) %in% yr.rng) %>%
  mutate(value=value)

# Helper functions ---------------------------------------------------------------------------
fixed.lead.plot <-
  function(this.obs,this.model,lead.idx) {
    this.realmean <-
      this.model %>%
      filter(realization=="realmean",
             leadIdx==lead.idx)

    this.preds <-
      this.model %>%
      filter(realization!="realmean",
             leadIdx==lead.idx) %>%
      dplyr::select(-startDate) %>%
      collect() %>%
      filter(year(date)%in% yr.rng) %>%
      group_by(date) %>%
      summarise(ptile=c("lower","upper"),
                value=quantile(value,probs=c(0.25,0.75))) %>%
      pivot_wider(names_from=ptile,values_from = value)

    ggplot()+
      geom_ribbon(data=this.preds,mapping=aes(x=year(date),ymax=upper,ymin=lower),fill="red",alpha=0.25)+
      geom_line(data=this.obs,mapping=aes(year(date),value))+
      geom_point(data=this.obs,mapping=aes(year(date),value))+
      geom_line(data=this.realmean,aes(year(date),value,colour=leadIdx))

  }



fixed.start.plot <-
  function(this.obs,this.model,year.start,ylab) {
    this.model <- 
      this.model %>%
      mutate(year=year(date),
             startYear=factor(year(startDate)))
    
    this.realmean <-
      this.model %>%
      mutate(year) %>%
      filter(realization=="realmean",
             year(startDate) %in% year.start) 
    
    this.preds <-
      this.model %>%
      filter(realization!="realmean",
             startYear %in% year.start,
             year%in% yr.rng) %>%
      group_by(startYear,year) %>%
      summarise(ptile=c("lower","upper"),
                value=quantile(value,probs=c(0.25,0.75))) %>%
      pivot_wider(names_from=ptile,values_from = value)

    this.reals <-
      this.model %>%
      filter(realization!="realmean",
             year(startDate) %in% year.start)


    ggplot()+
      geom_ribbon(data=this.preds,
                  mapping=aes(x=year,ymax=upper,ymin=lower,fill=startYear),
                  alpha=0.25)+
      # geom_line(data=this.reals,mapping=aes(x=year(date),y=value,group=paste(realization,startDate)),
      #             colour="red",alpha=0.25)+
      geom_line(data=this.obs,mapping=aes(year(date),value))+
      geom_point(data=this.obs,mapping=aes(year(date),value))+
      geom_line(data=this.realmean,aes(year,value,colour=startYear))  +
      labs(x="Year",y=ylab,fill="Forecast start",colour="Forecast start")


  }

# Bluefin habitat expansion -------------------------------------------------------
yr.rng <- 1980:2010
this.stk <- "Bluefin"



fixed.lead.plot(sel.obs,sel.model,5)
fixed.start.plot(sel.obs,sel.model,c(1980,1992,2004,2014),"Bluefin Habitat Northward Extent (deg Lat)")

```
```{r}
# Blue whiting  -------------------------------------------------------------------
yr.rng <- 1990:2020
this.stk <- "Blue_whiting_decadal"

sel.cfg <- 
  these.cfg %>%
  filter(name==this.stk) 

sel.tbl <-
  sel.cfg %>%
  select(db,spName,statName,resultName,calibrationMethod) %>%
  do.call(what=function(db,spName,statName,resultName,calibrationMethod) {
    tbl(db[[1]],PE.cfg$db$stats) %>%
      filter(spName==!!spName,
             statName==!!statName,
             resultName==!!resultName,
             calibrationMethod==!!calibrationMethod)
  }) 

sel.obs <-
  sel.tbl %>%
  filter(srcType=="Observations") %>%
  collect() %>%
  filter(year(date)%in% yr.rng,
         month(date) ==sel.cfg$pcfg[[1]]@MOI) %>%
  mutate(value=value/1e6)

sel.model <-
  sel.tbl %>%
  filter(srcType=="Decadal",
         srcName=="CESM.DPLE") %>%
  collect() %>%
  filter(year(date) %in% yr.rng) %>%
  mutate(value=value/1e6)

fixed.lead.plot(sel.obs,sel.model,3)
fixed.start.plot(sel.obs,sel.model,c(2004,2012),"Bluefin Tuna Habitat (Mkm²)")

```
```{r}
# Mackerel  -------------------------------------------------------------------
yr.rng <- 1980:2020
this.stk <- "Mackerel_summer"

sel.cfg <- 
  these.cfg %>%
  filter(name==this.stk) 

sel.tbl <-
  sel.cfg %>%
  select(db,spName,statName,resultName,calibrationMethod) %>%
  do.call(what=function(db,spName,statName,resultName,calibrationMethod) {
    tbl(db[[1]],PE.cfg$db$stats) %>%
      filter(spName==!!spName,
             statName==!!statName,
             resultName==!!resultName,
             calibrationMethod==!!calibrationMethod)
  }) 

sel.obs <-
  sel.tbl %>%
  filter(srcType=="Observations") %>%
  collect() %>%
  filter(year(date)%in% yr.rng,
         month(date) ==sel.cfg$pcfg[[1]]@MOI) %>%
  mutate(value=value/1e6)

sel.model <-
  sel.tbl %>%
  filter(srcType=="Decadal",
         srcName=="CESM.DPLE") %>%
  collect() %>%
  filter(year(date) %in% yr.rng) %>%
  mutate(value=value/1e6)

fixed.lead.plot(sel.obs,sel.model,5)
fixed.start.plot(sel.obs,sel.model,c(1990,2000,2010),"Bluefin Tuna Habitat (Mkm²)")

```

#'========================================================================
# Spatial Maps ####
# Figure 1 in manuscript
#'========================================================================

```{r}
#Configuration
this.lead <- c(67,62)
this.met <- "pearson.correlation"
relabel <- c(SST="a) SST (August)",
             Sal="b) Salinity (March, 250-600m)")

#Setup data
sp.met.cfg <- 
  metrics.dat %>%
  filter(fig == "spMet" ) 
  
sp.met <- 
  sp.met.cfg %>%
  select(lbl,var,dat) %>%
  unnest(dat) %>%
  mutate(dat=map(field,rasterToPoints),
         dat=map(dat,as_tibble),
         dat=map(dat,set_names,c("x","y","value"))) %>%
  select(lbl,var,lead,metric,dat) %>%
  unnest(dat) 

cor.thresh <- 
  sp.met.cfg %>%
  distinct(cor.thresh) %>%
  pull() %>%
  round(2)

#Extract polygons
sp.polys <- 
  skill.cfgs %>%
  pmap_dfr(function(...) {
    this <- list(...)
    this$pcfg@spatial.polygons %>%
      filter(name==this$spName) %>%
      mutate(var=this$var,
             lbl=gsub("^.*?)","",this$lbl))}) 

#Make plots
fill.breaks <- c(0.25,seq(0.4,0.8,by=0.2))
fill.lims <- c(-1,1)
fill.lbls <-  function(x) {sprintf("%02.2f",x)}
fill.pal <- brewer.pal(4,"Reds")
fill.ttl <- "Pearson\ncorrelation (r)"
fill.even <- FALSE

cor.map <- 
  sp.met %>%
  filter(metric=="pearson.correlation",
         lead %in%this.lead) %>%
  ggplot()+
  theme(panel.background = element_rect(fill="grey70"),
        panel.grid = element_blank(),
        legend.position = "right")+
  annotation_map(map_data("world"),fill="black")+
  geom_raster(aes(x,y,fill=value))+
  geom_sf(data=sp.polys,mapping=aes(linetype=lbl),fill=NA,colour="black")+
  facet_wrap(~var,
             as.table=FALSE,
             ncol=1,
             labeller = labeller(var=relabel))+
  binned_scale("fill","foo",
               ggplot2:::binned_pal(scales::manual_pal(c("white",fill.pal))),
               guide="coloursteps",
               breaks=fill.breaks,
               labels=fill.lbls,
               limits=fill.lims,
               show.limits=TRUE)+
  guides(fill=guide_colorsteps(even.steps = fill.even,
                               show.limits = TRUE,
                               title.position="top",
                               title=fill.ttl,
                               ticks=TRUE,
                               frame.colour="black"),
         linetype=guide_legend(title.position="top",
                               title="Area" ))+
  coord_sf(expand=FALSE)+
  labs(x="",y="")

print(cor.map)
```

```{r}
#Duplicate with MSS
fill.breaks <- seq(0,0.8,by=0.2)
fill.lims <- c(-1e6,1)
fill.lbls <-  function(x) {ifelse(x<0,expression(-infinity),sprintf("%02.2f",x))}
fill.pal <- brewer.pal(5,"Blues")
fill.ttl <- "MSSS"
fill.even <- TRUE

mss.map <- 
  filter(sp.met,
         metric=="MSSS",
         lead %in%this.lead) %>% 
    ggplot()+
  theme(panel.background = element_rect(fill="grey70"),
        panel.grid = element_blank(),
        legend.position = "right")+
  annotation_map(map_data("world"),fill="black")+
  geom_raster(aes(x,y,fill=value))+
  geom_sf(data=sp.polys,mapping=aes(linetype=lbl),fill=NA,colour="black")+
  facet_wrap(~var,
             as.table=FALSE,
             ncol=1,
             labeller = labeller(var=relabel))+
  binned_scale("fill","foo",
               ggplot2:::binned_pal(scales::manual_pal(c("white",fill.pal))),
               guide="coloursteps",
               breaks=fill.breaks,
               labels=fill.lbls,
               limits=fill.lims,
               show.limits=TRUE)+
  guides(fill=guide_colorsteps(even.steps = fill.even,
                               show.limits = TRUE,
                               title.position="top",
                               title=fill.ttl,
                               ticks=TRUE,
                               frame.colour="black"),
         linetype=guide_legend(title.position="top",
                               title="Area" ))+
  coord_sf(expand=FALSE)+
  labs(x="",y="")

print(mss.map)

```



***
*This work by Mark R Payne is licensed under a  Creative Commons
Attribution-NonCommercial-ShareAlike 3.0 Unported License. 
For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
Basically, this means that you are free to "share" and "remix" for 
non-commerical purposes as you see fit, so long as you "attribute" me for my
contribution. Derivatives can be distributed under the same or 
similar license.*

*This work comes with ABSOLUTELY NO WARRANTY or support.*

***



