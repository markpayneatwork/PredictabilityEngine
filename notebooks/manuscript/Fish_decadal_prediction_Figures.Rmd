---
title: "Fish_decadal_prediction_Figures"
output:
  html_document: default
---

```{r setup, include="FALSE"}
#'========================================================================
# Fish_decadal_prediction_Figures
#'========================================================================
#
# by Mark R Payne
# DTU-Aqua, Kgs. Lyngby, Denmark
# http://www.staff.dtu.dk/mpay
#
# Created Wed Jul  3 11:16:32 2019
#
# <Description>
#
# This work is subject to a Creative Commons "Attribution" "ShareALike" License.
# You are largely free to do what you like with it, so long as you "attribute"
# me for my contribution. See the fine print at the end for exact details.
#
# To do:
#
# Notes:
#
#'========================================================================

#Notes:
#Make sure when knitting that you have the Knit directory set to "project directory"

#Clean plate
rm(list=ls())

#Configure Knitr
knitr::opts_chunk$set(
  echo=FALSE,
	error = FALSE,
	message = FALSE,
	warning = FALSE,
	include = TRUE,
	results = "markup",
	fig.width = 10,         #Old 4:3
	fig.height=14/25*10,
	fig.width = 10,         #New 16:9
	fig.height=15/32*10,
  fig.align="center",
  fig.path=file.path(".","figures","Fish_decadal_prediction_Figures_"))

#Powerpoint needs 14 x 25cm figures

# knitr::opts_knit$set(
#    root.dir="..")

library(tidyverse)
library(ggplot2)
library(tibble)
library(scales)
library(lubridate)
library(here)
library(PredEng)
library(sf)
library(ggnewscale)
library(RSQLite)

theme_set(theme_bw(base_size = 14))
```

by Mark R Payne  <br>
DTU-Aqua, Kgs. Lyngby, Denmark  <br>
http://www.staff.dtu.dk/mpay  <br>
Wed Jul  3 11:16:32 2019

This notebook prepares figures for use in the manuscript "Skillful decadal-prediction of distributional shifts in North Atlantic pelagic fish".

## Skill Metrics for oceanographic variables

```{r}
#'========================================================================
# Spatial skill metrics for oceanographic variables ####
#'========================================================================
#Need to do special runs for SST and salinity (?)
this.dir <- "notebooks/manuscript"

Bluefin <- list(name="Bluefin",
                spName=="SouthOfIceland",
                statName=="threshold",
                resultName=="area",
                calibrationMethod=="MeanAdj",
                lbl="a) Bluefin tuna") 

BW <- list(name="Blue_whiting_decadal",
           spName=="Spawning area",
           statName=="SDM",
           resultName=="areaLarvae",
           calibrationMethod=="MeanAdj",
           lbl="b) Blue whiting")
Mac <- list(name="Mackerel_summer",
            spName=="East_Greenland",
            statName=="JansenTreshold",
            resultName=="area",
            calibrationMethod=="MeanAdj",
            lbl="c) Mackerel") 

cfgs <- 



BW.cfg <- readRDS(here(this.dir,"Blue_whiting_decadal_configuration.rds"))
BW.db <- dbConnect(SQLite(),here(this.dir,"Blue_whiting_decadal_results.sqlite")) 

Bluefin.cfg <- readRDS(here(this.dir,"Bluefin_configuration.rds"))
Bluefin.db <- dbConnect(SQLite(),here(this.dir,"Bluefin_results.sqlite"))

Mac.cfg <- readRDS(here(this.dir,"Mackerel_summer_configuration.rds"))
Mac.db <- dbConnect(SQLite(),here(this.dir,"Mackerel_summer_results.sqlite")) 

# sp <- 
#   c("Blue whiting"=BW.cfg@spatial.subdomains$ROI,
#         "Bluefina tuna"=Bluefin.cfg@spatial.subdomains$South.of.Iceland,
#         "Mackerel"=Mac.cfg@spatial.subdomains$Iceland) %>%
#   enframe(name="species",value="subdomain.obj")  %>%
#   mutate(sp.subdomain=map_chr(subdomain.obj,slot,"name"),
#          sp.obj=map(subdomain.obj,~ slot(.x,"boundary")),
#          sf.obj=map(sp.obj,st_as_sf,
#                     geometry=)) %>%
#   split(,f=.$species)
# 
# %>%
#   lapply(st_sf)





```


## Skill Metrics for each fish stock

```{r, fig.height=10,fig.width=5.6}
#'========================================================================
# Skill metrics by fish stock ####
##TODO:
## * Add statistical significance
## * Correct time axis
#'========================================================================
#Import and select skill metrics
Bluefin.skill <- 
  Bluefin.db %>%
  tbl(PE.cfg$db$metrics) %>%
  filter(spName=="SouthOfIceland",
         statName=="threshold",
         resultName=="area") %>%
  collect() %>%
  filter(calibrationMethod=="MeanAdj" | is.na(calibrationMethod)) %>%
  mutate(species="a) Bluefin tuna") 
BW.skill <- 
  BW.db %>%
  tbl(PE.cfg$db$metrics) %>%
  filter(spName=="Spawning area",
         statName=="SDM",
         resultName=="areaLarvae") %>%
  collect() %>%
  filter(calibrationMethod=="MeanAdj" | is.na(calibrationMethod)) %>%
  mutate(species="b) Blue whiting")
Mac.skill <- 
  Mac.db %>%
  tbl(PE.cfg$db$metrics) %>%
  filter(spName=="East_Greenland",
         statName=="JansenTreshold",
         resultName=="area") %>%
  collect() %>%
  filter(calibrationMethod=="MeanAdj" | is.na(calibrationMethod)) %>%
  mutate(species="c) Mackerel") 

#Combine
skill.dat <- 
  bind_rows(Bluefin.skill,
            BW.skill,
            Mac.skill) %>%
  filter(srcType %in% c("Decadal","Persistence"),
         realization %in% c("ensmean","realmean",NA))  %>%
  mutate(lead.yrs=lead/12,
         highlight=srcName=="ensmean" | srcType=="Persistence",
         dispName=ifelse(srcType=="Persistence","Persistence",srcName),
         dispName=fct_relevel(dispName,"ensmean","Persistence"),
         dispName=fct_recode(dispName,"Ens. mean"="ensmean"))

#Remove stray persistences
decadal.leads <- 
  skill.dat %>%
  filter(srcType=="Decadal") %>%
  distinct(species,lead) %>%
  unite(species.lead,species,lead) %>%
  pull()

cleaned.dat <- 
  skill.dat %>%
  filter(metric=="pearson.correlation") %>%
  unite(species.lead,species,lead,remove=FALSE) %>%
  filter(species.lead %in% decadal.leads) 

#Now split into individuals models
models.dat <- 
  cleaned.dat %>%
  filter(!highlight)

ensmean.dat <-
  cleaned.dat %>%
  filter(dispName=="Ens. mean") 

persis.dat <-
  cleaned.dat %>%
  filter(dispName=="Persistence") 

highlight.dat <-
  cleaned.dat %>%
  filter(highlight) 

#Calculate threshold cor following
#https://en.wikipedia.org/wiki/Pearson_product-moment_correlation_coefficient
#We use a one-tailed test at 5% CL
#This can be done using either a Fisher transformation:
#signif.cor <- tanh(qnorm(0.95)/sqrt(length(pcfg@clim.years)-3))
#However, it's easy to do it exactly in R, so we prefer that instead
cor.fn <- function(n) {
  deg.freedom <- n -2
  t.thresh <- qt(0.95,deg.freedom)
  signif.thresh <- t.thresh / sqrt(deg.freedom+t.thresh^2)
  return(signif.thresh)
}
cor.thresh <- 
  skill.dat %>%
  filter(metric=="n",
         srcType!="Persistence") %>%
  distinct(species,value) %>%
  mutate(threshold=cor.fn(value)) 

#Plot miscs
colour.pal <- hue_pal()(6)


g <- 
  #Setup baseline
  ggplot()+
  facet_wrap(~species,ncol=1)+
  geom_hline(data=cor.thresh,
             mapping=aes(linetype="r > 0 (p=5%)",
                         yintercept=threshold))+
  scale_linetype_manual(values="dotted")+
  coord_cartesian(xlim=c(0,10),ylim=c(0,1),expand=FALSE)+
  scale_x_continuous(breaks=0:10)+
  theme(legend.position="bottom")+
  labs(x="Lead time (years)",
       y="Pearson correlation coefficient (r)",
       linetype="Significance test")+
  #Individual model plots
  geom_line(data=models.dat,
            mapping=aes(x=lead.yrs,
                        y=value,
                        colour=dispName),
            size=0.2)+
  scale_colour_manual(values=colour.pal[-c(1:2)],
                      guide=guide_legend(order=2,ncol=1,
                                         title="Individual Models",title.position = "top"))+
  guides(linetype=guide_legend(title.position = "top"))+

  #Highlight plots
  new_scale_colour()+
  geom_line(data=highlight.dat,
            mapping=aes(x=lead.yrs,
                        y=value,
                        colour=dispName),
            size=2)+
  scale_colour_manual(values=colour.pal[1:2],
                      guide=guide_legend(order=1,ncol=1,
                                         title="Key Metrics",title.position = "top"))
print(g)



    
```


## Ability to forecast given years
```{r}
# Helper functions ---------------------------------------------------------------------------
fixed.lead.plot <- 
  function(this.obs,this.model,lead.idx) {
    this.realmean <- 
      this.model %>%
      filter(realization=="realmean",
             leadIdx==lead.idx)
    
    this.preds <- 
      this.model %>%
      filter(realization!="realmean",
             leadIdx==lead.idx) %>%
      dplyr::select(-startDate) %>%
      collect() %>%
      filter(year(date)%in% yr.rng) %>%
      group_by(date) %>%
      summarise(ptile=c("lower","upper"),
                value=quantile(value,probs=c(0.05,0.95))) %>%
      pivot_wider(names_from=ptile,values_from = value)
    
    ggplot()+
      geom_ribbon(data=this.preds,mapping=aes(x=year(date),ymax=upper,ymin=lower),fill="red",alpha=0.25)+
      geom_line(data=this.obs,mapping=aes(year(date),value))+
      geom_point(data=this.obs,mapping=aes(year(date),value))+
      geom_line(data=this.realmean,aes(year(date),value,colour=leadIdx))
    
  }



fixed.start.plot <- 
  function(this.obs,this.model,year.start,ylab) {
    this.realmean <- 
      this.model %>%
      filter(realization=="realmean",
             year(startDate) %in% year.start)
    
    this.preds <- 
      this.model %>%
      filter(realization!="realmean",
             year(startDate) %in% year.start) %>%
      collect() %>%
      filter(year(date)%in% yr.rng) %>%
      group_by(startDate,date) %>%
      summarise(ptile=c("lower","upper"),
                value=quantile(value,probs=c(0.05,0.95))) %>%
      pivot_wider(names_from=ptile,values_from = value)
    
    this.reals <- 
      this.model %>%
      filter(realization!="realmean",
             year(startDate) %in% year.start) 
    
    
    ggplot()+
      geom_ribbon(data=this.preds,mapping=aes(x=year(date),ymax=upper,ymin=lower,fill=startDate),
                  alpha=0.25)+
      # geom_line(data=this.reals,mapping=aes(x=year(date),y=value,group=paste(realization,startDate)),
      #             colour="red",alpha=0.25)+
      geom_line(data=this.obs,mapping=aes(year(date),value))+
      geom_point(data=this.obs,mapping=aes(year(date),value))+
      geom_line(data=this.realmean,aes(year(date),value,colour=startDate))  +
      labs(x="Year",y=ylab,fill="Forecast start",colour="Forecast start")
    
    
  }

# Bluefin habitat expansion -------------------------------------------------------
yr.rng <- 1980:2010

sel.stats <- 
  Bluefin.db %>%
  tbl(PE.cfg$db$stats) %>%
  filter(srcType %in% c("Decadal","Observations"),
         spName=="SouthOfIceland",
         statName=="threshold",
         resultName=="area",
         calibrationMethod=="MeanAdj")
sel.obs <- 
  filter(sel.stats,
         srcType=="Observations") %>%
  collect() %>%
  filter(year(date)%in% yr.rng,
         month(date) ==Bluefin.cfg@MOI) %>%
  mutate(value=value/1e6)

sel.model <-
  filter(sel.stats,
         srcType=="Decadal",
         srcName=="CESM.DPLE") %>%
  collect() %>%
  filter(year(date) %in% yr.rng) %>%
  mutate(value=value/1e6)

fixed.lead.plot(sel.obs,sel.model,1)
fixed.start.plot(sel.obs,sel.model,c(1980,1992,2004),"Bluefin Tuna Habitat (MkmÂ²)")

```
```{r}
# Blue whiting  -------------------------------------------------------------------
yr.rng <- 1980:2020

sel.stats <- 
  BW.db%>%
  tbl(PE.cfg$db$stats) %>%
  filter(srcType %in% c("Decadal","Observations"),
         spName=="SouthOfIceland",
         statName=="threshold",
         resultName=="area")
sel.obs <- 
  filter(sel.stats,
         srcType=="Observations") %>%
  collect() %>%
  filter(year(date)%in% yr.rng,
         month(date) ==Bluefin.cfg@MOI)

sel.model <-
  filter(sel.stats,
         srcType=="Decadal",
         srcName=="CESM.DPLE",
         calibrationMethod=="MeanAdj") %>%
  collect() %>%
  filter(year(date) %in% yr.rng)

fixed.lead.plot(sel.obs,sel.model,1)
fixed.start.plot(sel.obs,sel.model,c(1980,1992,2004))


```


***
*This work by Mark R Payne is licensed under a  Creative Commons
Attribution-NonCommercial-ShareAlike 3.0 Unported License. 
For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
Basically, this means that you are free to "share" and "remix" for 
non-commerical purposes as you see fit, so long as you "attribute" me for my
contribution. Derivatives can be distributed under the same or 
similar license.*

*This work comes with ABSOLUTELY NO WARRANTY or support.*

***



