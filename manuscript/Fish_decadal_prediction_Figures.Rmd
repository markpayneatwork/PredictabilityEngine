---
title: "Fish_decadal_prediction_Figures"
output:
  html_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include="FALSE"}
#'========================================================================
# Fish_decadal_prediction_Figures
#'========================================================================
#
# by Mark R Payne
# DTU-Aqua, Kgs. Lyngby, Denmark
# http://www.staff.dtu.dk/mpay
#
# Created Wed Jul  3 11:16:32 2019
#
# <Description>
#
# This work is subject to a Creative Commons "Attribution" "ShareALike" License.
# You are largely free to do what you like with it, so long as you "attribute"
# me for my contribution. See the fine print at the end for exact details.
#
# To do:
#
# Notes:
#
#'========================================================================

#Notes:
#Make sure when knitting that you have the Knit directory set to "project directory"

#Clean plate
rm(list=ls())

#Configure Knitr
knitr::opts_chunk$set(
  echo=FALSE,
  error = FALSE,
  message = FALSE,
  warning = FALSE,
  include = TRUE,
  results = "markup",
  #dev="CairoSVG",
  fig.width = 10,         #Old 4:3
  fig.height=14/25*10,
  fig.width = 10,         #New 16:9
  fig.height=15/32*10,
  fig.align="center",
  fig.path=file.path(".","figures","Fish_decadal_prediction_Figures_"))

#Powerpoint needs 14 x 25cm figures

# knitr::opts_knit$set(
#    root.dir="..")

library(PredEng)
library(scales)
library(here)
library(sf)
library(ggnewscale)
library(RSQLite)
library(RColorBrewer)
library(RcppRoll)
library(patchwork)
library(ggsci)
library(magrittr)
library(ggpattern)


theme_set(theme_bw())
theme_replace(strip.background = element_blank())

```

by Mark R Payne  <br>
DTU-Aqua, Kgs. Lyngby, Denmark  <br>
http://www.staff.dtu.dk/mpay  <br>
Wed Jul  3 11:16:32 2019

This notebook prepares figures for use in the manuscript "Skillful decadal-prediction of distributional shifts in North Atlantic pelagic fish".

```{r}
#'========================================================================
# Spatial skill metrics for oceanographic variables ####
#'========================================================================
#Setup
this.dir <- "manuscript"

cfgs <- list()
cfgs$"Mackerel-summer" <-
  tibble(tbl=PE.cfg$db$metrics,
         spName="Greenland",
         statName="JansenTreshold",
         resultName="area",
         calibrationMethod="MeanAdj",
         lbl="a) Mackerel",
         var="SST",
         fig="skill")
cfgs$Bluefin <- 
  tibble(tbl=PE.cfg$db$metrics,
         spName="MacKenzieEtAl",
         statName="threshold",
         resultName="area",
         calibrationMethod="MeanAdj",
         lbl="b) Bluefin tuna",
         var="SST",
         fig="skill") 
cfgs$"Blue-whiting-decadal" <-
  tibble(tbl=PE.cfg$db$metrics,
         spName="NorthernComponent",
         statName="SDM",
         resultName="areaMatchSurvey",
         # statName="threshold",
         # resultName="area",
         calibrationMethod="MeanAdj",
         lbl="c) Blue whiting",
         var="Sal",
         fig="skill")
cfgs$"NA-SST" <-
  tibble(tbl=PE.cfg$db$metrics.field,
         spName="global.ROI",
         statName="Field",
         resultName="field",
         calibrationMethod="MeanAdj",
         var="SST",
         fig="spMet",
         lbl="a) SST (August)")

cfgs$"NA-Sal" <-
  tibble(tbl=PE.cfg$db$metrics.field,
         spName="global.ROI",
         statName="Field",
         resultName="field",
         calibrationMethod="MeanAdj",
         var="Sal",
         fig="spMet",
         lbl="b) Salinity (March, 250-600m)")

#Import extermaÃ¦ pbkects
these.cfg <-
  bind_rows(cfgs,.id="name") %>%
  mutate(pcfg=map(name,~readRDS(here(this.dir,.x,"configuration.rds"))),
         stats.db=map(name,
                      ~dbConnect(SQLite(), 
                                 here(this.dir, .x, 
                                      sprintf("%s_Statistics.sqlite",.x)))), 
         mets.db=map(name,
                     ~dbConnect(SQLite(),
                                here(this.dir,.x,
                                     sprintf("%s_Metrics.sqlite",.x)))),
         met.field.db=map(name,
                          ~dbConnect(SQLite(),
                                     here(this.dir,.x,
                                          sprintf("%s_MetricsField.sqlite",.x))))) 

these.cfg %>%
  select(-(pcfg:met.field.db)) %>%
  print()
```


# Skill Metrics for each fish stock

```{r, fig.height=10,fig.width=5.6}
#'========================================================================
# Skill metrics by fish stock ####
##TODO:
## * Add statistical significance
## * Correct time axis
#'========================================================================
#Import data and select skill metrics
metrics.dat <-
  these.cfg %>%
  filter(fig=="skill") %>%
  rowwise() %>%
  group_split() %>%
  map_dfr(function(this) {
    this$mets.dat <- 
      this$mets.db[[1]] %>%
      tbl(PE.cfg$db$metrics) %>%
      filter(spName==!!this$spName,
             statName==!!this$statName,
             resultName==!!this$resultName) %>%
      collect() %>%
      filter(calibrationMethod==this$calibrationMethod | is.na(calibrationMethod)) %>%
      PE.db.unserialize() %>%
      list()
    return(this)
  })

#Process skill data
skill.cfgs <- 
  metrics.dat %>%
  filter(fig=="skill") 

skill.dat <- 
  skill.cfgs %>%
  select(lbl,mets.dat) %>%
  unnest(mets.dat) %>%
  filter(srcType %in% c("Decadal","Persistence","CMIP6"),
         realization %in% c("realmean",NA) | srcName=="grandens")  %>%
  mutate(lead.yrs=lead/12,
         highlight=srcType=="Decadal" & srcName=="grandens" | srcType=="Persistence" ,
         dispName=ifelse(srcType=="Persistence","Persistence",srcName),
         dispName=fct_relevel(dispName,"grandens","Persistence"),
         dispName=fct_recode(dispName,"Grand Ens."="grandens"))

#Remove stray persistences
decadal.leads <- 
  skill.dat %>%
  filter(srcType=="Decadal") %>%
  distinct(lbl,lead) %>%
  unite(lbl.lead,lbl,lead) %>%
  pull()

base.pal <- c("#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00") #Set1
base.pal <- pal_npg()(6)
plt.cfgs <-
  list(list(metric="pearson.correlation",
            ylab="Pearson correlation coefficient (r)",
            ylim=c(-0.1,1),
            signif.band =c(-0.1,0),
            show.signif=TRUE,
            two.panel=FALSE,
            panel.letters=c("a","b","c"),
            colour.pal=base.pal),
       #            colour.pal=c(base.pal[1],"grey",base.pal[3:5])),
       list(metric="MSSS",
            ttl="Mean Squared Error\nskill score (MSESS)",
            ylab="",
            signif.band=c(-1.2,-1),
            ylim=c(-1.2,1),
            show.signif=TRUE,
            two.panel=TRUE,
            panel.letters=c("a","c","e"),
            colour.pal=base.pal),
       list(metric="crpss",
            ttl="Continuous Ranked Probability\nskill score (CRPSS)",
            ylab="",
            ylim=c(-1.2,1),
            show.signif=FALSE,
            two.panel=TRUE,
            panel.letters=c("b","d","f"),
            colour.pal=base.pal))
#            colour.pal=c(base.pal[2],"grey",base.pal[3:5])))

met.plots <- list()
for(this.cfg in plt.cfgs) {
  cleaned.dat <- 
    skill.dat %>%
    filter(metric==this.cfg$metric) %>%
    unite(lbl.lead,lbl,lead,remove=FALSE) %>%
    filter(lbl.lead %in% decadal.leads) %>%
    mutate(lbl2=str_extract(lbl,"^.*\\)"))
  
  #Now split into individuals models
  models.dat <- 
    cleaned.dat %>%
    filter(!highlight)  #Use the best estimate 
  
  ensmean.dat <-
    cleaned.dat %>%
    filter(dispName=="Grand Ens.")
  
  persis.dat <-
    cleaned.dat %>%
    filter(dispName=="Persistence") 
  
  # CMIP6.dat <- 
  #   skill.dat %>%
  #   filter(srcType=="CMIP6",
  #          srcName=="ensmean",
  #          metric==this.cfg$metric) %>%
  #   mutate(upperCI=map_dbl(draws,quantile,probs=0.95),
  #          lowerCI=map_dbl(draws,quantile,probs=0.05))
  
  highlight.dat <-
    cleaned.dat %>%
    filter(highlight) %>%
    mutate(upperCI=map_dbl(draws,quantile,probs=0.95),
           lowerCI=map_dbl(draws,quantile,probs=0.05),
           dispName=factor(dispName,c("Grand Ens.","Persistence")))
  

# Make plot -------------------------------------------------------------------------
  this.plt <- 
    #Setup baseline
    ggplot()+
    facet_wrap(~lbl,
               ncol=1,
               strip.position = "right")+
    geom_hline(yintercept = 0)+
    scale_linetype_manual(values="dotted")+
    coord_cartesian(xlim=c(0,10),
                    ylim=this.cfg$ylim,
                    expand=FALSE)+
    scale_x_continuous(breaks=0:10)+
    theme(legend.position="bottom")+
    labs(x="Lead time (years)",
         y=this.cfg$ylab)+
    #Highlight bands
    geom_ribbon(mapping=aes(x=lead.yrs,
                            ymin=lowerCI,
                            ymax=upperCI,
                            fill=dispName),
                data=highlight.dat,
                alpha=0.25)+
    scale_fill_manual(values=this.cfg$colour.pal[1:2],
                      drop=FALSE,
                      guide=guide_legend(title="Key Metrics",
                                         order=1,ncol=1,
                                         title.position = "top"))+
    #Individual model plots
    geom_line(data=models.dat,
              mapping=aes(x=lead.yrs,
                          y=value,
                          colour=dispName),
              size=0.5)+
    scale_colour_manual(values=this.cfg$colour.pal[-c(1:2)],
                        guide=guide_legend(order=2,ncol=1,
                                           title="Individual Models",
                                           title.position = "top"))+
    guides(linetype=guide_legend(title.position = "top"))+
    
    #Highlight plots
    new_scale_colour()+
    geom_line(data=highlight.dat,
              mapping=aes(x=lead.yrs,
                          y=value,
                          colour=dispName),
              size=1.5)+
    scale_colour_manual(values=this.cfg$colour.pal[1:2],
                        drop=FALSE,
                        guide=guide_legend(order=1,ncol=1,
                                           title="Key Metrics",
                                           title.position = "top"))
    #CMIP6 error bars
    # geom_errorbar(data=CMIP6.dat,
    #              mapping=aes(x=9.5,ymin=lowerCI,ymax=upperCI))+
    # geom_point(data=CMIP6.dat,
    #            mapping=aes(x=9.5,y=value))

    #Add significance (if appropriate)
    if(this.cfg$show.signif) {
      
      signif.breaks <- c(-1,0.005,0.01,0.05,1)
      signif.lbls <- c("p < 0.005","p < 0.01", "p < 0.05", "Not Signif.")
      
      signif.dat <- 
        highlight.dat %>% 
        select(lbl,lead.yrs,draws,dispName) %>%
        pivot_wider(names_from="dispName",values_from = "draws") %>%
        #Join in CMIP6 draws as well
        #   left_join(y=select(CMIP6.dat,lbl,CMIP6.draws=draws),by="lbl") %>%
        #Calculate p.values
        mutate(p.value=map2_dbl(`Grand Ens.`,Persistence, ~ mean(.x < .y)),
               #   p.CMIP6=map2_dbl(`Ens. mean`,CMIP6.draws,~ mean(.x<.y)),
               p.txt=cut(p.value,breaks=signif.breaks,
                         labels=signif.lbls),
               p.ns=ifelse(p.value>0.05,"ns",""))
      
      this.plt <-
        this.plt + 
        #Significance band 
        annotate("rect",xmin=0,xmax=10,
                 ymin=min(this.cfg$signif.band),ymax=max(this.cfg$signif.band),
                 fill="white",colour="black")+

        geom_point(data=signif.dat,
                   mapping=aes(x=lead.yrs,shape=p.txt,size=p.txt),
                   y=mean(this.cfg$signif.band))+
        scale_shape_manual(values=c(16,8,3,16),
                           drop=FALSE,
                           guide=guide_legend(order=3,ncol=1,
                                              title="Signif. test",
                                              title.position = "top"))+
        scale_size_manual(values=c(4,2,1,0.1),
                          drop=FALSE,
                          guide=guide_legend(order=3,ncol=1,
                                             title="Signif. test",
                                             title.position = "top")) 
    }  
  
  #Make tweaks for two panels
  if(this.cfg$two.panel) {
    panel.lbls <- 
      cleaned.dat %>%
      distinct(lbl) %>%
      mutate(panel.lbl=sprintf("%s)",this.cfg$panel.letters))
    this.plt <- 
      this.plt + 
      ggtitle(this.cfg$ttl)+
      facet_wrap(~lbl,ncol=1,
                 strip.position = "right",
                 labeller = function(x) {
                   x$lbl <- gsub("^.*) ","",x$lbl)
                   return(x)} )  +
      ylab(NULL) +
      geom_text(panel.lbls,
                x=-Inf,y=Inf,hjust=-1,vjust=2,
                mapping=aes(label=panel.lbl))+
      theme(strip.background = element_blank(),
            strip.placement = "outside",
            panel.spacing.y = unit(5,"mm"),
            plot.title = element_text(size=10,hjust=0.5),
            strip.text=element_text(hjust=0.5))
  } else {
    panel.lbls <- 
      cleaned.dat %>%
      distinct(lbl) %>%
      mutate(panel.lbl=sprintf("%s)",this.cfg$panel.letters))
    this.plt <- 
      this.plt + 
      facet_wrap(~lbl,ncol=1,
                 strip.position = "right",
                 labeller = function(x) {
                   x$lbl <- str_remove(x$lbl,"^.*\\) ")
                   return(x)} )  +
      ylab(this.cfg$ylab) +
      geom_text(panel.lbls,
                x=-Inf,y=Inf,hjust=-1,vjust=2,
                mapping=aes(label=panel.lbl))+
      theme(strip.background = element_blank(),
            strip.placement = "outside",
            panel.spacing.y = unit(5,"mm"),
            plot.title = element_text(size=10,hjust=0.5),
            strip.text=element_text(hjust=0.5))    
  }
  
  if(this.cfg$metric=="MSSS") {
    this.plt <- 
      this.plt +
      theme(strip.text.y=element_blank())   
  }
  
  met.plots[[this.cfg$metric]] <- this.plt  
  
  }

print(met.plots[1])
wrap_plots(met.plots[2:3],ncol=2,guides="collect")  & 
  theme(legend.position = 'bottom')

```

# Effect of smoothing

```{r}
#Import data and select skill metrics
smooth.dat <-
  these.cfg %>%
  filter(fig=="skill") %>%
  rowwise() %>%
  group_split() %>%
  map_dfr(function(this) {
    this$dat <- 
      this$mets.db[[1]] %>%
      tbl(PE.cfg$db$metrics) %>%
      filter(srcName=="grandens" | srcType=="Persistence",
             spName==!!this$spName,
             statName==!!this$statName) %>%
      collect() %>%
      filter(calibrationMethod==this$calibrationMethod | is.na(calibrationMethod)) %>%
      filter(grepl(this$resultName,resultName))%>%
      PE.db.unserialize() %>%
      list()
    return(this)
  }) %>%
  select(lbl,dat) %>%
  unnest(dat) %>%
  mutate(lead.yr=lead/12) %>%
#  filter(metric %in% c("MSSS","pearson.correlation")) %>%
  filter(metric %in% c("pearson.correlation")) %>%
  separate(resultName,c("resultName","smoothing"),sep=" / ",fill="right") %>%
  mutate(smoothing=case_when(is.na(smoothing) ~ "1 year",
                             smoothing=="RollMean03" ~ "3 years",
                             smoothing=="RollMean05" ~ "5 years",
                             smoothing=="RollMean09" ~ "9 years"),
         dispName=ifelse(srcType=="Decadal","Grand Ens.",srcType),
         ylbl=case_when(metric=="pearson.correlation"~ "Pearson correlation coefficient(r)",
                        metric=="MSSS" ~ "MSESS")) %>%
  filter(!is.na(smoothing))  #Drop other windows
         # lbl=factor(lbl),
         # lbl=fct_relabel(lbl,function(x) gsub("^[a-c]) ","",x)))

#Only show persistences that are also in the Ens.mean
ensmean.metrics <- 
  smooth.dat %>%
  filter(dispName=="Grand Ens.",
         !is.na(value)) %>%
  select(lbl,ylbl,smoothing,lead) %>%
  mutate(have.Ensmean=TRUE)

smooth.plt <- 
  smooth.dat %>%
  left_join(y=ensmean.metrics) %>%
  filter(have.Ensmean)

#Points at end of lines
end.points <-
  smooth.plt %>%
  group_by(lbl,ylbl,dispName,smoothing) %>%
  filter(lead==min(lead)| lead==max(lead)) %>%
  ungroup()

#Panel labels
panel.lbls <- 
  smooth.dat %>%
  distinct(lbl) %>%
  mutate(panel.lbl=str_extract(lbl,"^.*\\)"))
  
g <- 
  #Setup baseline
  ggplot()+
  facet_grid(~lbl,
             switch = "y",
             labeller = function(x) {x$lbl <- str_remove(x$lbl,"^.*\\) "); x})+
  geom_text(panel.lbls,
            x=-Inf,y=Inf,hjust=-1,vjust=2,
            mapping=aes(label=panel.lbl))+
  
  # geom_text(data=facet.lbls, mapping=aes(x,y,label=this.lbl),
  #           hjust="left",vjust="top")+
  # #annotate("rect",xmin=0,xmax=10,ymin=1,ymax=c(1,1.2),fill="white",colour="black")+
  coord_cartesian(xlim=c(0,10),
                  ylim=c(0,1),
                  expand=FALSE)+
  scale_x_continuous(breaks=0:10)+
  geom_hline(yintercept=0)+
  theme(legend.position="bottom",
        strip.placement = "outside",
        panel.spacing.x = unit(4,"mm"))+
  labs(x="Lead time (years)",
       y="Pearson correlation coefficient (r)")+
  #Lines
  geom_line(data=smooth.plt,
            mapping=aes(x=lead.yr,
                        y=value,
                        colour=dispName,
                        linetype=smoothing))+
  geom_point(data=end.points,
              mapping=aes(x=lead.yr,
                          y=value,
                          colour=dispName,
                          shape=smoothing),
             size=2)+
  scale_linetype_manual(values=c(1,2,3,4))+
  scale_shape_manual(values=c(NA,15:19))+
  guides(shape=guide_legend(title="Mean window"),
         colour=guide_legend(title="Metrics",
                             title.position = "left",
                             order=1,
                             override.aes = list(shape=NA)),
         linetype=guide_legend(title="Mean window",
                               title.position = "left")) 

print(g)


```

### Table of skills

```{r}
tbl.dat <-
  smooth.plt %>%
  select(lbl,dispName,lead.yr,draws,value,smoothing) %>%
  pivot_wider(names_from=c("dispName"),values_from=c("draws","value")) %>%
  filter(!is.na(smoothing)) %>%
  mutate(p.value=map2_dbl(`draws_Grand Ens.`,draws_Persistence,~ mean(.x <.y)),
         "Grand Ens."=map_dbl(`value_Grand Ens.`,~.x),
         Persistence=map_dbl(value_Persistence,~.x)) %>%
  select(-starts_with("draws"),-starts_with("value"))

  knitr::kable(
    tbl.dat %>%
      filter(round(lead.yr)==5)%>%
      select(Species=lbl,
             Smoothing=smoothing,
             "Grand Ens.",
             Persistence,
             "p value"=p.value),
    digits=3)
```

# Fixed lead plot

```{r}
this.lead.idx <- 5

#Import data
fl.dat <-
  these.cfg %>%
  filter(fig=="skill") %>%
  rowwise() %>%
  group_split() %>%
  map_dfr(function(this) {
    this$dat <- 
      this$stats.db[[1]] %>%
      tbl(PE.cfg$db$stats) %>%
      filter(srcType %in% c("Decadal","Observations"),
             spName==!!this$spName,
             statName==!!this$statName,
             !srcName %like% "ensmean%",
             !srcName %like% "grandens /%",
             realization!="realmean" | is.na(realization),
             calibrationMethod==!!this$calibrationMethod | calibrationMethod=="None",
             resultName ==!!this$resultName,
             month(date)==!!this$pcfg[[1]]@MOI,
             year(date) %in% !!this$pcfg[[1]]@comp.years,
             lead < this.lead.idx*12 & lead > (this.lead.idx-1)*12 | is.na(lead)) %>%
      filter(!(srcType=="Observations" & calibrationMethod!="None")) %>%
      select(-field) %>%
      collect() %>%
      list()
    return(this)
  }) %>%
  select(lbl,dat) %>%
  unnest(dat) %>%
  mutate(year=year(date))

fl.grandens <-
  fl.dat %>%
  filter(srcName=="grandens")

fl.obs <-
  fl.dat %>%
  filter(srcType=="Observations") %>%
  arrange(lbl,date) %>%
  group_by(lbl) %>%
  mutate(rollmean=roll_mean(value,n=3,fill=NA)) %>%
  select(lbl,year,Habitat=value,"Rolling mean"=rollmean) %>%
  pivot_longer(-c(lbl,year)) 

fl.preds <-
  fl.dat %>%
  filter(srcName!="grandens",
         srcType=="Decadal") %>%
  dplyr::select(-startDate) %>%
  group_by(lbl,date) %>%
  summarise(ptile=c("lower","upper"),
            value=quantile(value,probs=c(0.25,0.75)),
            .groups="drop") %>%
  pivot_wider(names_from=ptile,values_from = value)

panel.lbls <- 
  fl.grandens %>%
  distinct(lbl) %>%
  mutate(panel.lbl=str_extract(lbl,"^.*\\)"))


fixed.lead.plt <-
  ggplot()+
  facet_wrap(~lbl,
             ncol=1,
             strip.position = "right",
             scale="free_y",
             labeller = function(x){x$lbl <- str_remove(x$lbl,"^.*\\) "); x})+
  #Ribbon
  geom_ribbon(data=fl.preds,
              mapping=aes(x=year(date),ymax=upper,ymin=lower,
                          fill=sprintf("%i year lead",this.lead.idx)),
              alpha=0.25)+
  #Observations
  geom_line(data=fl.obs,
            mapping=aes(year,value,linetype=name,col=name,size=name))+
  geom_point(data=fl.obs,
             mapping=aes(year,value,shape=name),size=2)+
  scale_color_manual(values=c("black","black"))+
  scale_shape_manual(values=c(17,NA))+
  scale_size_manual(values=c(0.5,1))+
  scale_linetype_manual(values=c("dotted","solid"))+
  labs(col="Observations",
       linetype="Observations",
       size="Observations",
       shape="Observations",
       alpha="Observations")+
  #Forecast line
  new_scale_color()+
  geom_line(data=fl.grandens,
            aes(year,value,colour=sprintf("%i year lead",this.lead.idx)))+
  scale_color_manual(values=c("red"))+
  #Annotations
  labs(x="Year",
       y="Habitat area (kkmÂ²)",
       col="Forecast",
       fill="Forecast")+
  scale_y_continuous(labels=function(x) x/1000)+
  geom_text(panel.lbls,
            x=-Inf,y=Inf,hjust=-1,vjust=2,
            mapping=aes(label=panel.lbl))


print(fixed.lead.plt)

```


# Ability to forecast given years
```{r}
#'========================================================================
# Mackerel comparison ####
#'========================================================================

# Setup configuration -------------------------------------------------------------
this.cfg <-
  these.cfg %>%
  filter(name=="Mackerel-summer") %>%
  mutate(yr.rng=list(1980:2020),
         starts=list(c(1980,1990,2000,2010)),
         scalar=1/1e3,
         lbl2="Mackerel habitat (kkmÂ²)")

#Import data
stat.dat <- 
  this.cfg$stats.db[[1]] %>%
  tbl(PE.cfg$db$stats) %>%
  filter(spName==!!this.cfg$spName,
         statName==!!this.cfg$statName,
         resultName==!!this.cfg$resultName,
         calibrationMethod==!!this.cfg$calibrationMethod | calibrationMethod=="None")%>%
  select(-field) %>%
  collect() %>%
  mutate(year=year(date),
         startYear=factor(year(startDate)),
         value=value*this.cfg$scalar)

#Extract data
this.obs <- 
  stat.dat %>%
  filter(srcType=="Observations",
         calibrationMethod=="None",
         realization=="realmean",
         month(date) ==this.cfg$pcfg[[1]]@MOI) %>%
  arrange(date) %>%
  mutate(rollmean=roll_mean(value,n=3,fill=NA)) %>%
  select(year,Habitat=value,"Rolling mean"=rollmean) %>%
  pivot_longer(-year) 

this.model <- 
  stat.dat %>%
  filter(srcType=="Decadal",
         srcName=="CESM.DPLE") 

forecast.realmean <-
  this.model %>%
  filter(realization=="realmean",
         year(startDate) %in% this.cfg$starts[[1]]) 

forecast.real.rng <-
  this.model %>%
  filter(realization!="realmean",
         startYear %in% this.cfg$starts[[1]],
         year %in% this.cfg$yr.rng[[1]]) %>%
  group_by(startYear,year) %>%
  summarise(ptile=c("lower","upper"),
            value=quantile(value,probs=c(0.05,0.95)),
            .groups="drop") %>%
  pivot_wider(names_from=ptile,values_from = value)


#Loop over start dates
start.date.plt <- list()
startDate.l <- list(this.cfg$starts[[1]],
                    NA,
                    1990,
                    c(1990,2010))

for(i in seq(startDate.l)) {
  these.starts <- startDate.l[[i]]
  start.date.plt[[i]] <- 
    ggplot()+
    #Forecasts
    geom_ribbon(data=filter(forecast.real.rng,startYear %in% these.starts),
                mapping=aes(x=year,ymax=upper,ymin=lower,fill=startYear),
                alpha=0.25)+
    geom_line(data=filter(forecast.realmean,startYear %in% these.starts),
              mapping=aes(year,value,col=startYear))  +
    scale_fill_npg(guide=guide_legend(order=2))+
    scale_colour_npg(guide=guide_legend(order=2))+
    labs(colour="Forecast",
         fill="Forecast")+
    new_scale_color()+
    #Observations
    geom_line(data=this.obs,
              mapping=aes(year,value,linetype=name,col=name))+
    geom_point(data=this.obs,
               mapping=aes(year,value,shape=name),size=2)+
    scale_color_manual(values=c("darkgrey","black","black"),
                       guide=guide_legend(order=1))+
    scale_shape_manual(values=c(17,NA,NA),
                       guide=guide_legend(order=1))+
    scale_size_manual(values=c(0.5,0,5),
                      guide=guide_legend(order=1))+
    scale_linetype_manual(values=c("dotted","longdash","dashed"),
                          guide=guide_legend(order=1))+
    #Annotations
    labs(x="Year",
         y=this.cfg$lbl2,
         colour="Observations",
         linetype="Observations",
         shape="Observations",
         size="Observations")+
    scale_x_continuous(limits=range(this.cfg$yr.rng[[1]]))+
    scale_y_continuous(limits=range(pretty(c(0,forecast.real.rng$upper))),
                       expand=c(0,0))+
    theme(legend.position = "none")
              
  #Turn legend and annotations back on for final version
  #Disable this section when making animations
  start.date.plt[[i]] <-
    start.date.plt[[i]] +
    theme(legend.position = "bottom",
          legend.direction = "vertical")+
    annotate("text",x=-Inf,y=Inf,hjust=-1,vjust=2,label="a)")
}

Mack.plt <- start.date.plt[[1]]

#Write plots for animation
# for(i in seq(2,length(start.date.plt))) {
#   ggsave(here("manuscript/figures/",sprintf("Mackerel_animation_%02i.png",i)),
#          start.date.plt[[i]],
#         width=239/2,height=146/2,units="mm",
#         dpi=300)
# }


#'========================================================================
# Blue Whiting forecast comparison ####
#'========================================================================
#Setup
this.cfg <- 
  these.cfg %>%
  filter(name=="Blue-whiting-decadal")%>%
  mutate(yr.rng=list(2004:2019),
         starts=list(c(2010:2020)),
         scalar=1/1e3,
         lbl2="Blue whiting spawning area (kkmÂ²)")

surv.dat <- 
  readRDS(here("manuscript/Distribution_metrics.rds")) %>%
  pivot_longer(-c(year,src)) %>%
  filter(name=="surv.area",
         src=="WGIPS") %>%
  mutate(value=value*this.cfg$scalar,
         lbl="Distribution (Survey)")

library(icesSAG)
SSB.dat <- 
  getSummaryTable(13880) %>%  #2020 Assessment, Key from website
  extract2(1) %>%
  as_tibble() %>%
  dplyr::select(Year,SSB)
  

#Import data
stat.dat <- 
  this.cfg$stats.db[[1]] %>%
  tbl(PE.cfg$db$stats) %>%
  filter(spName==!!this.cfg$spName,
         statName==!!this.cfg$statName,
         resultName==!!this.cfg$resultName,
         calibrationMethod==!!this.cfg$calibrationMethod | calibrationMethod=="None")%>%
  select(-field) %>%
  collect() %>%
  mutate(year=year(date),
         startYear=factor(year(startDate)),
         value=value*this.cfg$scalar)

#Extract data
this.obs <- 
  stat.dat %>%
  filter(srcType=="Observations",
         calibrationMethod=="None",
         realization=="realmean",
         month(date) ==this.cfg$pcfg[[1]]@MOI) %>%
  arrange(date) %>%
  mutate(rollmean=roll_mean(value,n=3,fill=NA)) %>%
  select(year,Habitat=value,"Habitat roll. mean"=rollmean) %>%
  pivot_longer(-year)

this.model <- 
  stat.dat %>%
  filter(srcType=="Decadal",
         srcName=="CESM.DPLE",
         !realization %in% c("realmean","grandens","ensmean"),
         year(startDate) %in% c(2004,2011),
         lead/12<7)  %>%
  mutate(startYear=factor(year(startDate)))

forecast.mean <-
  this.model %>%
  group_by(startYear,year) %>%
  summarise(value=mean(value),
            .groups="drop") 

forecast.rng <-
  this.model %>%
  filter(realization!="grandens") %>%
  group_by(startYear,year) %>%
  summarise(ptile=c("lower","upper"),
            value=quantile(value,probs=c(0.05,0.95)),
            .groups="drop") %>%
  pivot_wider(names_from=ptile,values_from = value)

# Forecast plot -------------------------------------------------------------------
BW.plot <- 
  ggplot()+
  #Background fill
  annotate("rect",xmin=-Inf,xmax=Inf,ymax=0,ymin=-Inf,fill="white",colour="black")+
  #Forecasts
  geom_ribbon(data=forecast.rng,
              mapping=aes(x=year,ymax=upper,ymin=lower,fill=startYear),
              alpha=0.25)+
  geom_line(data=forecast.mean,
            mapping=aes(year,value,col=startYear))  +
  scale_fill_npg(guide=guide_legend(order=2))+
  scale_colour_npg(guide=guide_legend(order=2))+
  labs(colour="Forecast",
       fill="Forecast")+
  new_scale_color()+
  #Lines
  geom_line(data=this.obs, #Observed Habitat
            mapping=aes(year,value,linetype=name,col=name))+
  geom_line(data=surv.dat, #Blue whiting survey observations
            mapping=aes(x=year,y=value,col=lbl,linetype=lbl))+
  scale_linetype_manual(values=c("dotdash","dotted","longdash"),
                        guide=guide_legend(order=1))+
  scale_color_manual(values=c("red","darkgrey","black"),
                     guide=guide_legend(order=1))+
  labs(colour="Observations",
       linetype="Observations")+  
  #Points
  new_scale_color()+
  geom_point(data=this.obs,
             mapping=aes(year,value,col=name,shape=name),size=2)+
  geom_point(data=surv.dat,
             mapping=aes(x=year,y=value,col=lbl,shape=lbl),fill="white",size=2)+
  scale_color_manual(values=c("red","black","black"),
                     guide=guide_legend(title="Observations",order=1))+
  scale_shape_manual(values=c(22,17,NA),
                     guide=guide_legend(title="Observations",order=1))+
  #SSB timeseries
  geom_point(data=SSB.dat,
             mapping=aes(x=Year,y=-10,size=SSB/1e6),shape=16)+
  scale_size_area(breaks=c(2,4,6),
                  labels=sprintf("%i Mt",c(2,4,6)),
                  guide=guide_legend(title="Biomass",order=3))+
  #Annotations
  labs(x="Year",
       y=this.cfg$lbl2)+
  scale_x_continuous(limits=c(2004,2019))+
  scale_y_continuous(limits=c(-20,300),expand=c(0,0))+
  theme(legend.position = "bottom",
        legend.direction = "vertical")+
  annotate("text",x=-Inf,y=Inf,hjust=-1,vjust=2,label="b)")


wrap_plots(Mack.plt,BW.plot,nrow=1)

```


# Spatial Skill Maps 

```{r}
#Configuration
this.lead <- c(67,62)
this.met <- "pearson.correlation"
#relabel <-


#Extract polygons
sp.polys <-
  skill.cfgs %>%
  pmap_dfr(function(...) {
    this <- list(...)
    this$pcfg@spatial.polygons %>%
      filter(name==this$spName) %>%
      mutate(var=this$var,
             lbl=gsub("^.*?) ","",this$lbl))}) %>%
  mutate(lbl=factor(lbl,lbl),
         var=fct_rev(var))

#Make plots
sp.plt.cfg <- list()
sp.plt.cfg$cor <-
  list(metric="pearson.correlation",
       fill.breaks= c(0,seq(0.2,0.8,by=0.2)),
       fill.lims = c(-1,1),
       fill.lbls =  function(x) {sprintf("%02.2f",x)},
       fill.pal = ggplot2:::binned_pal(scales::manual_pal(c("white",brewer.pal(5,"Reds")))),
       #fill.pal= ggplot2:::binned_pal(viridis_pal()),
       fill.ttl = "Pearson\ncorrelation (r)",
       fill.even = FALSE)

sp.plt.cfg$msss <-
  list(metric="MSSS",
       fill.breaks = seq(0,0.8,by=0.2),
       fill.lims = c(-1e6,1),
       fill.lbls =  function(x) {ifelse(x<0,expression(-infinity),sprintf("%02.2f",x))},
       fill.pal = ggplot2:::binned_pal(scales::manual_pal(c("white",brewer.pal(5,"Blues")))),
       fill.ttl = "MSESS",
       fill.even = TRUE)

sp.plots <- list()

for(plt.cfg in sp.plt.cfg) {
  #Setup data
  sp.dat <-
    these.cfg %>%
    filter(fig == "spMet" ) %>%
    rowwise() %>%
    group_split() %>%
    map_dfr(function(this) {
      this$dat <-
        this$met.field.db[[1]] %>%
        tbl(PE.cfg$db$metrics.field) %>%
        filter(spName==!!this$spName,
               statName==!!this$statName,
               srcName=="grandens",
               lead %in% !!this.lead,
               resultName==!!this$resultName) %>%
        collect() %>%
        filter(calibrationMethod==this$calibrationMethod,
               str_starts(metric,!!plt.cfg$metric)) %>%
        PE.db.unserialize() %>%
        list()
      return(this)
    })
  
  met.tbl <-
    sp.dat %>%
    select(lbl,var,dat) %>%
    unnest(dat) %>%
    #widen to allow calculation of significance
    mutate(metric.type=ifelse(str_ends(metric,".draws"),"draws","metric")) %>%
    select(lbl,var,metric.type,field) %>%
    pivot_wider(names_from=metric.type,values_from="field") %>%
    mutate(signif=map(draws,~ mean(.x>0))) %>%
    select(-draws) %>%
    pivot_longer(-c(lbl,var)) %>%
    #Convert raster to a tibble for plotting
    mutate(dat=map(value,rasterToPoints),
           dat=map(dat,as_tibble),
           dat=map(dat,set_names,c("x","y","value"))) %>%
    select(-value) %>%
    unnest(dat) %>%
    #Set factors
    mutate(var=fct_rev(var))
  
   met.sp <-
    met.tbl %>%
    filter(name=="metric")
    
   met.sig <-
     met.tbl %>%
     filter(name=="signif") %>%
     mutate(signif=ifelse(value<0.95,TRUE,NA)) %>%
     select(var,x,y,signif) %>%
     nest(data=c(x,y,signif)) %>%
     mutate(raster=map(data,rasterFromXYZ),
            poly=map(raster,rasterToPolygons,dissolve=TRUE),
            poly=map(poly,st_as_sf),
            poly=map2(poly,var,~cbind(.x,var=.y))) %>%
     pull(poly) %>%
     bind_rows() %>%
     st_set_crs(crs(sp.polys)) %>%
     st_cast("POLYGON")
   
   panel.lbls <- 
     met.tbl %>%
     distinct(var) %>%
     mutate(panel.lbl=sprintf("%s)",letters[1:2]))
     
   
   #Make plot
  sp.plots[[plt.cfg$metric]] <-
    ggplot(met.sp)+
    theme(panel.background = element_rect(fill="grey70"),
          panel.grid = element_blank(),
          legend.position = "right")+
    annotation_map(map_data("world"),fill="black")+
    facet_wrap(~ var,
               ncol=2,
               labeller = labeller(var=  c(SST="SST (August)",
                                           Sal="Salinity (March, 250-600m)")))+
    #Raster
    geom_raster(aes(x,y,fill=value))+
    binned_scale("fill","foo",
                 palette=plt.cfg$fill.pal,
                 guide="coloursteps",
                 breaks=plt.cfg$fill.breaks,
                 labels=plt.cfg$fill.lbls,
                 limits=plt.cfg$fill.lims,
                 show.limits=TRUE)+
    # #Significance
    geom_sf_pattern(data=met.sig,
                    aes(pattern_fill="Not significant\n(p>0.05)"),
                    fill=NA,
                    pattern="stripe",
                    pattern_colour="grey70",
                    pattern_density=0.01,
                    pattern_spacing=0.01,
                    colour=NA)+
    #Polygons
    geom_sf(data=sp.polys,
            mapping=aes(linetype=lbl),
            fill=NA,
            size=0.75,
            colour="black")+
    scale_linetype_manual(values=c(1,2,3))+
    #Annotations
    guides(fill=guide_colorsteps(even.steps = plt.cfg$fill.even,
                                 show.limits = TRUE,
                                 title.position="top",
                                 title=plt.cfg$fill.ttl,
                                 ticks=TRUE,
                                 order=1,
                                 frame.colour="black"),
           pattern_fill=guide_legend(title=element_blank(),
                                     order=2),
           linetype=guide_legend(title.position="top",
                                 title="Region of\nInterest",
                                 order=4,
                                 override.aes = list(size=0.5)))+
    coord_sf(expand=FALSE)+
    labs(x="",y="")+
    #Labels
    geom_label(data=panel.lbls,mapping=aes(label=panel.lbl),
               x=-80,y=80,hjust=0,vjust=1)
  

}

#wrap_plots(sp.plots,ncol=2)
print(sp.plots)

```



***
*This work by Mark R Payne is licensed under a  Creative Commons
Attribution-NonCommercial-ShareAlike 3.0 Unported License. 
For details, see http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US
Basically, this means that you are free to "share" and "remix" for 
non-commerical purposes as you see fit, so long as you "attribute" me for my
contribution. Derivatives can be distributed under the same or 
similar license.*

*This work comes with ABSOLUTELY NO WARRANTY or support.*

***



